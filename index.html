<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 CNY Trip | å—éƒ¨è‡ªé§•éŠ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts: Noto Sans TC + Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'muji-bg': '#F7F7F7',      /* ç±³ç°èƒŒæ™¯ */
                        'muji-card': '#FFFFFF',    /* ç´”ç™½å¡ç‰‡ */
                        'muji-text': '#333333',    /* å¢¨é»‘æ–‡å­— */
                        'muji-sub': '#8D8D8D',     /* ç°è‰²è¼”åŠ© */
                        'muji-accent': '#A89B8C',  /* éœ§æ£•è‰²é»ç¶´ */
                        'muji-dark': '#404040',    /* æ·±ç°æŒ‰éˆ• */
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', '"Inter"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F7F7F7;
            color: #333333;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* éš±è— Scrollbar ä½†ä¿æŒæ»‘å‹• */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* å¡ç‰‡èˆ‡é™°å½±é¢¨æ ¼ */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            /* transition: transform 0.1s active; */
            transition: transform 0.1s ease;
        }
        .card:active {
            transform: scale(0.99);
        }

        /* åº•éƒ¨å°èˆªæ¬„ */
        .nav-item.active {
            color: #404040;
            font-weight: 600;
        }
        .nav-item.active i {
            color: #A89B8C;
        }
        .nav-item {
            color: #9CA3AF;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        /* Input é¢¨æ ¼ */
        .muji-input {
            border: 1px solid #E5E5E5;
            border-radius: 8px;
            padding: 10px;
            background: #F9F9F9;
            width: 100%;
            outline: none;
            transition: border-color 0.2s;
        }
        .muji-input:focus {
            border-color: #A89B8C;
            background: #FFFFFF;
        }

        /* Modal å‹•ç•« */
        .modal-enter {
            opacity: 0;
            transform: translateY(20px);
        }
        .modal-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.3s ease-out;
        }
    </style>
</head>
<body class="h-screen flex flex-col font-sans overflow-hidden">

    <!-- Header -->
    <header class="bg-white px-4 py-3 shadow-sm z-20 flex justify-between items-center shrink-0">
        <h1 class="text-lg font-bold tracking-wider text-muji-dark">CNY TRIP <span class="text-xs font-normal text-muji-sub ml-1">2026</span></h1>
        
        <div class="flex items-center gap-2">
          <span id="cloud-status" class="text-[11px] px-2 py-1 rounded-full bg-gray-100 text-muji-sub">
            <i class="fa-solid fa-circle-notch fa-spin mr-1"></i> é€£ç·šä¸­
          </span>
        
          <div class="text-xs text-muji-sub bg-gray-100 px-2 py-1 rounded-full">
            <i class="fa-solid fa-car mr-1"></i> å—éƒ¨è‡ªé§•
          </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="app-content" class="flex-1 overflow-y-auto p-4 pb-24 no-scrollbar relative">
        <!-- Views will be injected here via JavaScript -->
    </main>

    <!-- Bottom Navigation -->
    <nav class="bg-white border-t border-gray-100 fixed bottom-0 w-full pb-safe z-30 shadow-[0_-2px_10px_rgba(0,0,0,0.03)]" style="padding-bottom: env(safe-area-inset-bottom);">
        <div class="flex justify-around items-center h-16 pb-1">
            <button onclick="switchTab('plan')" class="nav-item flex flex-col items-center justify-center w-full h-full active" id="nav-plan">
                <i class="fa-solid fa-calendar-day text-lg mb-1"></i>
                <span>è¡Œç¨‹</span>
            </button>
            <button onclick="switchTab('guide')" class="nav-item flex flex-col items-center justify-center w-full h-full" id="nav-guide">
                <i class="fa-solid fa-book-open text-lg mb-1"></i>
                <span>å°è¦½</span>
            </button>
            <button onclick="switchTab('food')" class="nav-item flex flex-col items-center justify-center w-full h-full" id="nav-food">
                <i class="fa-solid fa-utensils text-lg mb-1"></i>
                <span>ç¾é£Ÿ</span>
            </button>
            <button onclick="switchTab('wallet')" class="nav-item flex flex-col items-center justify-center w-full h-full" id="nav-wallet">
                <i class="fa-solid fa-wallet text-lg mb-1"></i>
                <span>è¨˜å¸³</span>
            </button>
            <button onclick="switchTab('lists')" class="nav-item flex flex-col items-center justify-center w-full h-full" id="nav-lists">
                <i class="fa-solid fa-list-check text-lg mb-1"></i>
                <span>æ¸…å–®</span>
            </button>
            <button onclick="switchTab('info')" class="nav-item flex flex-col items-center justify-center w-full h-full" id="nav-info">
                <i class="fa-solid fa-circle-info text-lg mb-1"></i>
                <span>è³‡è¨Š</span>
            </button>
        </div>
    </nav>

    <!-- JavaScript Logic -->
    <script>
        // --- Data & State Management ---
        const DB_KEY_PLAN = 'cny_trip_plan_v2';
        const DB_KEY_WALLET = 'cny_trip_wallet_v2';
        const DB_KEY_LISTS = 'cny_trip_lists_v2';
        const DB_KEY_FOOD = 'cny_trip_food_v2';
        
        window.DB_KEY_PLAN = DB_KEY_PLAN;
        window.DB_KEY_WALLET = DB_KEY_WALLET;
        window.DB_KEY_LISTS = DB_KEY_LISTS;
        window.DB_KEY_FOOD = DB_KEY_FOOD;

        let currentTab = 'plan';
        // let window.tripData = {
        window.tripData = {
            plan: [],
            wallet: { entries: [], currency: 'TWD', rate: 1 },
            lists: {
                checklist: [
                    {text: "é§•ç…§ã€è¡Œç…§ã€ETCã€ç¾é‡‘/ä¿¡ç”¨å¡", done: false},
                    {text: "è¡Œå‹•é›»æºã€å……é›»ç·šã€è»Šå……", done: false},
                    {text: "é˜²æ›¬ã€å¸½å­ã€å¢¨é¡ã€è–„å¤–å¥—", done: false},
                    {text: "é›¨å…·ï¼ˆæŠ˜ç–Šå‚˜/è¼•ä¾¿é›¨è¡£ï¼‰", done: false},
                    {text: "å¸¸å‚™è—¥ï¼ˆæšˆè»Šã€æ­¢ç—›ã€è…¸èƒƒã€OKç¹ƒï¼‰", done: false},
                    {text: "æ°´ã€é›¶é£Ÿ", done: false},
                    {text: "ç›¸æ©Ÿ/æ‰‹æ©Ÿã€æ¸…ç©ºå®¹é‡", done: false},
                    {text: "ä½å®¿è¨‚æˆ¿æˆªåœ–", done: false},
                    {text: "åƒåœ¾è¢‹ã€æ¿•ç´™å·¾", done: false}
                ],
                notes: []
            },
            food: []
        };

        // Default Itinerary Data
        const defaultPlan = [
            {
                day: 1, title: "åˆäºŒï¼šé«˜é›„ â†’ å¢¾ä¸", date: "Day 1",
                items: [
                    { time: "ä¸Šåˆ", title: "å›å¤–å…¬å®¶åƒé£¯", desc: "è¼•é¬†å®‰æ’ï¼Œä¸è¶•è¡Œç¨‹", type: "family", done: false },
                    { time: "ä¸‹åˆ", title: "é«˜é›„æ™¯é»äºŒé¸ä¸€", desc: "A) é§äºŒç‰¹å€ (33m) æˆ– B) è¥¿å­ç£ (39m)", type: "choice", badge: "ğŸš— 35åˆ†", done: false },
                    { time: "å‚æ™š", title: "é–‹è»Šå‰å¾€å¢¾ä¸", desc: "è»Šç¨‹ç´„ 1 å°æ™‚ 56 åˆ†é˜", type: "drive", badge: "ğŸš— 1h 56m", done: false },
                    { time: "æ™šä¸Š", title: "å¢¾ä¸å¤§è¡— / ä½å®¿", desc: "ä½å®¿é›¢å¤§è¡—è¿‘ï¼Œå¯éš¨æ„é€›é€›", type: "hotel", done: false }
                ]
            },
            {
                day: 2, title: "åˆä¸‰ï¼šæµ·ç”Ÿé¤¨ â†’ å°å—", date: "Day 2",
                items: [
                    { time: "ä¸Šåˆ", title: "åœ‹ç«‹æµ·æ´‹ç”Ÿç‰©åšç‰©é¤¨", desc: "é›¢ä½å®¿20åˆ†é˜ï¼Œä¸ç”¨æ’éšŠ", type: "spot", badge: "ğŸš— 20m", done: false },
                    { time: "ä¸­åˆ", title: "åˆé¤æ™‚é–“", desc: "æµ·ç”Ÿé¤¨å‘¨é‚Šæˆ–é¤¨å…§", type: "food", done: false },
                    { time: "ä¸‹åˆ", title: "è·¯é‚Šæ™¯å€ / å¹³å°", desc: "å½ˆæ€§è¡Œç¨‹ï¼Œçœ‹æµ·å¹é¢¨", type: "relax", done: false },
                    { time: "å‚æ™š", title: "é–‹è»Šå›å°å—", desc: "è¦–é«”åŠ›æ±ºå®šå‡ºç™¼æ™‚é–“", type: "drive", badge: "ğŸš— 2h", done: false },
                    { time: "æ™šä¸Š", title: "å°å—å®¶è£¡", desc: "è¡Œæè¼•ä¾¿ï¼Œèˆ’é©ä¼‘æ¯", type: "home", done: false }
                ]
            },
            {
                day: 3, title: "åˆå››ï¼šå¥‡ç¾ â†’ åé¼“", date: "Day 3",
                items: [
                    { time: "09:30", title: "å¥‡ç¾åšç‰©é¤¨", desc: "09:30 é–‹é–€ï¼Œå¾å®¶å‡ºç™¼22åˆ†", type: "spot", badge: "ğŸš— 22m", tag:"09:30 é–‹é–€", done: false },
                    { time: "ä¸­åˆ", title: "è‰çš®é‡é¤ / é¤è»Š", desc: "è¼•é¬†ç”¨é¤", type: "food", done: false },
                    { time: "ä¸‹åˆ", title: "åé¼“æ–‡åŒ–åœ’å€", desc: "å°±åœ¨éš”å£ï¼Œ4åˆ†é˜è»Šç¨‹", type: "spot", badge: "ğŸš— 4m", done: false },
                    { time: "å‚æ™š", title: "åé¼“å¤œæ™¯", desc: "åœ’å€å¤œæ™¯æ¼‚äº®ï¼Œé©åˆæ‹ç…§", type: "view", tag:"å¤œæ™¯æ¨è–¦", done: false },
                    { time: "æ™šä¸Š", title: "å›å®¶æ™šé¤", desc: "è»Šç¨‹ç´„ 30 åˆ†é˜", type: "home", badge: "ğŸš— 30m", done: false }
                ]
            },
            {
                day: 4, title: "åˆäº”ï¼šå˜‰ç¾©è“‹å©­ â†’ å›ç¨‹", date: "Day 4",
                items: [
                    { time: "08:30", title: "å˜‰ç¾© è“‹å©­èŠåœ’", desc: "08:30 é–‹åœ’ï¼Œè»Šç¨‹ç´„56åˆ†", type: "spot", badge: "ğŸš— 56m", tag:"08:30 é–‹åœ’", done: false },
                    { time: "ä¸­åˆ", title: "åœ’å€å…§ç”¨é¤", desc: "æœ‰é¤å»³ï¼Œæ–¹ä¾¿ä¼‘æ¯", type: "food", tag:"åœ’å€ç”¨é¤", done: false },
                    { time: "ä¸‹åˆ", title: "æ…¢æ…¢å›ç¨‹", desc: "å¯éš¨æ™‚æ–°å¢è‡¨æ™‚æ™¯é»", type: "drive", tag:"å½ˆæ€§", done: false }
                ]
            }
        ];

        // Guide Content (Static)
        const guideData = {
            "spot1": {
                name: "é§äºŒè—è¡“ç‰¹å€",
                content: "å‰èº«ç‚ºæ¸¯å£å€‰åº«ï¼Œç¾æ”¹å»ºç‚ºé–‹æ”¾å¼è—è¡“ç©ºé–“ã€‚é©åˆæ•£æ­¥ã€çœ‹å±•ã€æ‹è£ç½®è—è¡“ã€‚<br><strong>äº®é»ï¼š</strong> å¤§æ¸¯æ©‹æ—‹è½‰ã€æ–‡å‰µå¸‚é›†ã€‚<br><strong>æ³¨æ„ï¼š</strong> å‡æ—¥äººå¤šï¼Œåœè»Šéœ€æ‰¾å‘¨é‚Šåœè»Šå ´ã€‚"
            },
            "spot2": {
                name: "åœ‹ç«‹æµ·æ´‹ç”Ÿç‰©åšç‰©é¤¨",
                content: "å…¨å°æœ€å¤§æµ·ç”Ÿé¤¨ï¼Œåˆ†ç‚ºå°ç£æ°´åŸŸé¤¨ã€çŠç‘šç‹åœ‹é¤¨ã€ä¸–ç•Œæ°´åŸŸé¤¨ã€‚<br><strong>å¿…çœ‹ï¼š</strong> ä¼éµé¤µé£Ÿç§€ã€å°ç™½é¯¨ã€æµ·åº•éš§é“ã€‚<br><strong>å»ºè­°åœç•™ï¼š</strong> 2.5 - 3 å°æ™‚ã€‚",
                map: "https://www.openstreetmap.org/export/embed.html?bbox=120.693%2C22.043%2C120.700%2C22.049&layer=mapnik"
            },
            "spot3": {
                name: "å¥‡ç¾åšç‰©é¤¨",
                content: "è¥¿æ´‹è—è¡“é¢¨æ ¼å»ºç¯‰ï¼Œæ”¶è—è±å¯Œçš„å…µå™¨ã€æ¨‚å™¨ã€å‹•ç‰©æ¨™æœ¬èˆ‡è¥¿æ´‹ç•«ä½œã€‚<br><strong>æ‹ç…§é»ï¼š</strong> å¥§æ—å¸•æ–¯æ©‹ã€é˜¿æ³¢ç¾…å™´æ³‰å»£å ´ã€‚<br><strong>å‚™è¨»ï¼š</strong> æˆ¶å¤–åœ’å€å…è²»ï¼Œé€²é¤¨éœ€é–€ç¥¨ã€‚",
                map: "https://www.openstreetmap.org/export/embed.html?bbox=120.224%2C22.932%2C120.229%2C22.936&layer=mapnik"
            },
            "spot4": {
                name: "åé¼“æ–‡åŒ–åœ’å€",
                content: "ç”±èˆŠä»å¾·ç³–å» æ”¹å»ºï¼Œçµåˆé¼“æ¨‚è¡¨æ¼”èˆ‡æ¥µé™è¨­æ–½ã€‚<br><strong>äº®é»ï¼š</strong> å¤¢ç³–åŠ‡å ´é¼“æ¨‚è¡¨æ¼”ã€é­”æ³•å·¥å» å ´æ™¯ã€‚<br><strong>æ¨è–¦ï¼š</strong> å‚æ™šå…¥åœ’å¯çœ‹æ—¥æ™¯æ¥å¤œæ™¯ã€‚",
            },
            "spot5": {
                name: "è“‹å©­èŠåœ’",
                content: "ä»¥å¸Œè‡˜ç¥è©±ç‚ºä¸»é¡Œçš„ä¿é¤Šå“èŠåœ’ï¼Œç™½è‰²å·´æ´›å…‹å»ºç¯‰éå¸¸å£¯è§€ã€‚<br><strong>é©åˆï¼š</strong> åª½åª½æ‹ç…§ã€è³¼è²·ä¿é¤Šå“ä¼´æ‰‹ç¦®ã€‚<br><strong>é¤é£²ï¼š</strong> å…‹æ´›çµ²çš„èŠ±åœ’é¤å»³ (ç»ç’ƒå±‹)ã€‚"
            }
        };

        // --- Core Functions ---

        function init() {
            // Load Plan
            const savedPlan = localStorage.getItem(DB_KEY_PLAN);
            if (savedPlan) {
                window.tripData.plan = JSON.parse(savedPlan);
            } else {
                window.tripData.plan = JSON.parse(JSON.stringify(defaultPlan));
                saveData('plan');
            }

            // Load Other Data
            const savedWallet = localStorage.getItem(DB_KEY_WALLET);
            if (savedWallet) window.tripData.wallet = JSON.parse(savedWallet);
            
            const savedLists = localStorage.getItem(DB_KEY_LISTS);
            if (savedLists) window.tripData.lists = JSON.parse(savedLists);

            const savedFood = localStorage.getItem(DB_KEY_FOOD);
            if (savedFood) window.tripData.food = JSON.parse(savedFood);

            renderView();
        }

        let cloudSyncTimer = null;

        function requestCloudSync() {
          if (!window.__pushTripToCloud) return;
          clearTimeout(cloudSyncTimer);
          cloudSyncTimer = setTimeout(() => window.__pushTripToCloud(), 500);
        }

        function saveData(type) {
            if (type === 'plan') localStorage.setItem(window.DB_KEY_PLAN, JSON.stringify(window.tripData.plan));
            if (type === 'wallet') localStorage.setItem(window.DB_KEY_WALLET, JSON.stringify(window.tripData.wallet));
            if (type === 'lists') localStorage.setItem(window.DB_KEY_LISTS, JSON.stringify(window.tripData.lists));
            if (type === 'food') localStorage.setItem(window.DB_KEY_FOOD, JSON.stringify(window.tripData.food));
            // if (window.__pushTripToCloud) window.__pushTripToCloud();

            if (window.__pushTripToCloud) requestCloudSync();
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${tab}`).classList.add('active');
            // window.scrollTo(0, 0);
            document.getElementById('app-content').scrollTop = 0;
            renderView();
        }

        function renderView() {
            const container = document.getElementById('app-content');
            container.innerHTML = '';

            switch(currentTab) {
                case 'plan': renderPlan(container); break;
                case 'guide': renderGuide(container); break;
                case 'food': renderFood(container); break;
                case 'wallet': renderWallet(container); break;
                case 'lists': renderLists(container); break;
                case 'info': renderInfo(container); break;
            }
        }
        window.renderView = renderView;

        // --- 1. PLAN MODULE ---
        function renderPlan(container) {
            let html = `<div class="pb-2">`;
            
            window.tripData.plan.forEach((day, dayIndex) => {
                html += `
                    <div class="mb-8">
                        <div class="flex items-center mb-4 sticky top-0 bg-[#F7F7F7] z-10 py-2">
                            <div class="bg-muji-dark text-white text-xs font-bold px-3 py-1 rounded-full mr-2">${day.date}</div>
                            <h2 class="text-lg font-bold text-muji-text">${day.title}</h2>
                        </div>
                        <div class="space-y-4 relative pl-4 border-l-2 border-gray-200 ml-3">
                `;

                day.items.forEach((item, itemIndex) => {
                    const opacity = item.done ? 'opacity-50' : 'opacity-100';
                    const strike = item.done ? 'line-through text-gray-400' : '';
                    const checkIcon = item.done ? 'fa-circle-check text-green-500' : 'fa-circle text-gray-300';
                    const isCustom = item.isCustom ? '<span class="text-[10px] bg-blue-100 text-blue-600 px-1 rounded ml-2">CUSTOM</span>' : '';
                    
                    html += `
                        <div class="card p-4 relative ${opacity}">
                            <div class="absolute -left-[25px] top-4 bg-[#F7F7F7] rounded-full p-1">
                                <i class="fa-regular ${checkIcon} text-lg cursor-pointer bg-white rounded-full" onclick="togglePlanItem(${dayIndex}, ${itemIndex})"></i>
                            </div>
                            <div class="flex justify-between items-start mb-1">
                                <div class="text-sm font-bold text-muji-accent">${item.time}</div>
                                <div class="flex gap-1">
                                    ${item.badge ? `<span class="text-[10px] bg-stone-100 text-stone-600 px-2 py-0.5 rounded"><i class="fa-solid fa-car"></i> ${item.badge}</span>` : ''}
                                    ${item.tag ? `<span class="text-[10px] bg-red-50 text-red-500 px-2 py-0.5 rounded">${item.tag}</span>` : ''}
                                    ${isCustom}
                                </div>
                            </div>
                            <h3 class="text-base font-bold mb-1 ${strike}">${item.title}</h3>
                            <p class="text-sm text-gray-500 mb-3 ${strike}">${item.desc}</p>
                            
                            <div class="flex gap-2">
                                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.title)}" target="_blank" class="flex-1 bg-stone-50 text-stone-600 text-center py-2 rounded text-sm hover:bg-stone-100 border border-stone-100">
                                    <i class="fa-solid fa-map-location-dot mr-1"></i> å°èˆª
                                </a>
                                ${item.isCustom ? `<button onclick="deletePlanItem(${dayIndex}, ${itemIndex})" class="px-3 py-2 rounded text-red-400 bg-red-50"><i class="fa-solid fa-trash"></i></button>` : ''}
                            </div>
                        </div>
                    `;
                });

                // Add Custom Item Button
                html += `
                        <div class="mt-4 pt-2">
                            <button onclick="openAddPlanModal(${dayIndex})" class="w-full py-2 border border-dashed border-gray-300 text-gray-400 rounded-lg text-sm hover:bg-gray-50 hover:text-gray-500 transition">
                                <i class="fa-solid fa-plus mr-1"></i> æ–°å¢è¡Œç¨‹
                            </button>
                        </div>
                    </div></div>
                `;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        function togglePlanItem(dIdx, iIdx) {
            window.tripData.plan[dIdx].items[iIdx].done = !window.tripData.plan[dIdx].items[iIdx].done;
            saveData('plan');
            renderView();
        }

        // --- 2. GUIDE MODULE ---
        function renderGuide(container) {
            let html = `<div class="grid gap-4">`;
            const keys = Object.keys(guideData);
            
            keys.forEach(key => {
                const spot = guideData[key];
                html += `
                    <div class="card overflow-hidden">
                        ${spot.map ? `<iframe width="100%" height="200" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="${spot.map}" class="bg-gray-100"></iframe>` : ''}
                        <div class="p-5">
                            <h3 class="text-xl font-bold mb-2 text-muji-dark">${spot.name}</h3>
                            <div class="text-sm text-gray-600 leading-relaxed space-y-2">
                                ${spot.content}
                            </div>
                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(spot.name)}" target="_blank" class="block mt-4 text-center bg-muji-dark text-white py-2 rounded-lg text-sm">
                                <i class="fa-brands fa-google mr-1"></i> Google Maps
                            </a>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        // --- 3. FOOD MODULE ---
        function renderFood(container) {
            let html = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-muji-dark">ç¾é£Ÿæ¸…å–®</h2>
                    <button onclick="openAddFoodModal()" class="bg-muji-accent text-white px-3 py-1.5 rounded-lg text-sm shadow-sm">
                        <i class="fa-solid fa-plus"></i> æ–°å¢
                    </button>
                </div>

                <!-- Filters -->
                <div class="flex gap-2 overflow-x-auto no-scrollbar mb-4 pb-1">
                    <button onclick="filterFood('all')" class="whitespace-nowrap px-3 py-1 bg-white border border-gray-200 rounded-full text-xs text-gray-600 focus:bg-stone-600 focus:text-white">å…¨éƒ¨</button>
                    <button onclick="filterFood('æœªåƒ')" class="whitespace-nowrap px-3 py-1 bg-white border border-gray-200 rounded-full text-xs text-gray-600 focus:bg-stone-600 focus:text-white">æœªåƒ</button>
                    <button onclick="filterFood('area-kaohsiung')" class="whitespace-nowrap px-3 py-1 bg-white border border-gray-200 rounded-full text-xs text-gray-600 focus:bg-stone-600 focus:text-white">é«˜é›„</button>
                    <button onclick="filterFood('area-kenting')" class="whitespace-nowrap px-3 py-1 bg-white border border-gray-200 rounded-full text-xs text-gray-600 focus:bg-stone-600 focus:text-white">å¢¾ä¸</button>
                    <button onclick="filterFood('area-tainan')" class="whitespace-nowrap px-3 py-1 bg-white border border-gray-200 rounded-full text-xs text-gray-600 focus:bg-stone-600 focus:text-white">å°å—</button>
                     <button onclick="filterFood('area-chiayi')" class="whitespace-nowrap px-3 py-1 bg-white border border-gray-200 rounded-full text-xs text-gray-600 focus:bg-stone-600 focus:text-white">å˜‰ç¾©</button>
                </div>

                <div id="food-list" class="space-y-3">
            `;

            if(window.tripData.food.length === 0) {
                html += `<div class="text-center text-gray-400 py-10">å°šç„¡ç¾é£Ÿè³‡æ–™ï¼Œé»æ“Šå³ä¸Šè§’æ–°å¢</div>`;
            } else {
                window.tripData.food.forEach((item, idx) => {
                    if (window.foodFilter && !checkFoodFilter(item, window.foodFilter)) return;
                    
                    const eatenStyle = item.eaten ? 'opacity-60 bg-gray-50' : 'bg-white';
                    html += `
                        <div class="card p-4 ${eatenStyle}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs font-bold text-muji-accent border border-muji-accent px-1 rounded">${item.area}</span>
                                        <span class="text-xs text-gray-400">${item.type}</span>
                                        <span class="text-xs text-gray-500 font-mono">${item.price}</span>
                                    </div>
                                    <h3 class="font-bold text-lg text-muji-text ${item.eaten ? 'line-through' : ''}">${item.name}</h3>
                                    <p class="text-sm text-gray-500 mt-1">${item.note || 'ç„¡å‚™è¨»'}</p>
                                </div>
                                <button onclick="toggleFoodEaten(${idx})" class="text-2xl ${item.eaten ? 'text-green-500' : 'text-gray-200'}">
                                    <i class="fa-solid fa-circle-check"></i>
                                </button>
                            </div>
                            <div class="mt-3 flex gap-2 border-t pt-3 border-gray-100">
                                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.name + " " + item.area)}" target="_blank" class="flex-1 text-center py-1.5 text-xs bg-gray-100 rounded text-gray-600">
                                    <i class="fa-solid fa-location-arrow"></i> åœ°åœ–
                                </a>
                                <button onclick="openAddToPlanFromFood(${idx})" class="flex-1 py-1.5 text-xs bg-stone-600 text-white rounded">
                                    <i class="fa-regular fa-calendar-plus"></i> å…¥è¡Œç¨‹
                                </button>
                                <button onclick="deleteFood(${idx})" class="px-3 py-1.5 text-xs text-red-400 bg-red-50 rounded">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            html += `</div>`;
            container.innerHTML = html;
        }

        let currentFilter = 'all';
        function filterFood(type) {
            window.foodFilter = type;
            renderView();
        }
        function checkFoodFilter(item, filter) {
            if (filter === 'all') return true;
            if (filter === 'æœªåƒ') return !item.eaten;
            if (filter.startsWith('area-')) {
                const areaMap = {'area-kaohsiung':'é«˜é›„', 'area-kenting':'å¢¾ä¸', 'area-tainan':'å°å—', 'area-chiayi':'å˜‰ç¾©'};
                return item.area === areaMap[filter];
            }
            return true;
        }

        // --- 4. WALLET MODULE ---
        function renderWallet(container) {
            const total = window.tripData.wallet.entries.reduce((sum, item) => sum + parseInt(item.amount), 0);
            
            let html = `
                <div class="card p-4 mb-4 bg-stone-700 text-white shadow-lg">
                    <div class="text-xs text-stone-300 mb-1">ç¸½æ”¯å‡º (TWD)</div>
                    <div class="text-3xl font-bold font-mono">$${total.toLocaleString()}</div>
                    <div class="mt-4 pt-3 border-t border-stone-600 flex justify-between items-center">
                         <div class="text-xs text-stone-300">
                            è¨ˆç®—æ©Ÿ / åŒ¯ç‡
                         </div>
                         <button onclick="toggleCalculator()" class="bg-stone-500 px-3 py-1 rounded text-xs">é–‹å•Ÿå·¥å…·</button>
                    </div>
                    <!-- Calculator Section (Hidden by default) -->
                    <div id="calculator-panel" class="hidden mt-3 pt-2 border-t border-stone-600">
                        <div class="flex gap-2 mb-2">
                             <input id="calc-input" type="text" placeholder="è¼¸å…¥ç®—å¼ ex: 50+20*3" class="w-full bg-stone-600 text-white px-2 py-1 rounded outline-none font-mono">
                             <button onclick="runCalc()" class="bg-stone-400 px-3 rounded font-bold">=</button>
                        </div>
                        <div id="calc-result" class="text-right font-mono text-yellow-400 font-bold h-6"></div>
                    </div>
                </div>

                <!-- Add Expense Form -->
                <div class="card p-4 mb-4">
                    <h3 class="font-bold mb-3 text-sm text-gray-500">æ–°å¢è¨˜å¸³</h3>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="text" id="exp-name" placeholder="å“é …" class="muji-input">
                        <input type="number" id="exp-amount" placeholder="é‡‘é¡" class="muji-input">
                    </div>
                    <div class="flex gap-2 mb-2">
                         <select id="exp-cat" class="muji-input w-1/2">
                            <option value="é¤é£²">é¤é£²</option>
                            <option value="äº¤é€š">äº¤é€š</option>
                            <option value="é–€ç¥¨">é–€ç¥¨</option>
                            <option value="è³¼ç‰©">è³¼ç‰©</option>
                            <option value="ä½å®¿">ä½å®¿</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                        <div class="w-1/2 relative overflow-hidden bg-gray-100 rounded-lg flex items-center justify-center text-gray-400 cursor-pointer">
                            <i class="fa-solid fa-camera mr-2"></i> ç…§ç‰‡
                            <input type="file" id="exp-img" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleImagePreview(this)">
                        </div>
                    </div>
                    <div id="img-preview-area" class="hidden mb-2 text-xs text-green-600"><i class="fa-solid fa-check"></i> åœ–ç‰‡å·²é¸æ“‡</div>
                    <button onclick="addExpense()" class="w-full bg-stone-600 text-white py-2 rounded-lg font-bold">è¨˜éŒ„</button>
                </div>

                <!-- History List -->
                <div class="space-y-3 pb-4">
            `;

            [...window.tripData.wallet.entries].reverse().forEach((item, idx) => {
                const realIdx = window.tripData.wallet.entries.length - 1 - idx;
                html += `
                    <div class="card p-3 flex items-center gap-3">
                        <div class="w-12 h-12 bg-gray-100 rounded-lg flex-shrink-0 overflow-hidden flex items-center justify-center">
                            ${item.img ? `<img src="${item.img}" class="w-full h-full object-cover" onclick="viewImage('${item.img}')">` : `<i class="fa-solid fa-receipt text-gray-300"></i>`}
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <span class="font-bold text-muji-text">${item.name}</span>
                                <span class="font-bold font-mono">$${parseInt(item.amount).toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between mt-1">
                                <span class="text-xs text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">${item.cat}</span>
                                <span class="text-xs text-gray-400">${item.date}</span>
                            </div>
                        </div>
                        <button onclick="deleteExpense(${realIdx})" class="text-gray-300 hover:text-red-400 px-2"><i class="fa-solid fa-times"></i></button>
                    </div>
                `;
            });

            html += `</div>`;
            container.innerHTML = html;
        }

        function escapeHtml(str) {
          return str.replace(/[&<>"']/g, (m) => ({
            "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;"
          }[m]));
        }
        
        function linkifySafe(str) {
          const escaped = escapeHtml(str);
          return escaped.replace(/(https?:\/\/[^\s]+)/g,
            `<a href="$1" target="_blank" rel="noopener noreferrer" class="text-blue-500 underline">
              <i class="fa-solid fa-link"></i> é€£çµ
             </a>`
          );
        }
        
        // --- 5. LISTS MODULE ---
        function renderLists(container) {
            let html = `
                <!-- Checklist -->
                <div class="card p-4 mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-muji-dark"><i class="fa-solid fa-suitcase-rolling mr-2 text-muji-accent"></i>è¡Œå‰æº–å‚™</h3>
                        <span class="text-xs text-gray-400">${window.tripData.lists.checklist.filter(i=>i.done).length}/${window.tripData.lists.checklist.length}</span>
                    </div>
                    <div class="space-y-2">
            `;
            
            window.tripData.lists.checklist.forEach((item, idx) => {
                const check = item.done ? 'fa-square-check text-stone-600' : 'fa-square text-gray-200';
                const textStyle = item.done ? 'line-through text-gray-400' : '';
                html += `
                    <div class="flex items-center gap-3 py-1 cursor-pointer" onclick="toggleChecklist(${idx})">
                        <i class="fa-regular ${check} text-lg"></i>
                        <span class="${textStyle}">${item.text}</span>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    <div class="mt-3 flex gap-2">
                        <input type="text" id="new-check-item" placeholder="æ–°å¢é …ç›®..." class="muji-input text-sm py-1">
                        <button onclick="addChecklist()" class="bg-gray-200 px-3 rounded text-gray-600"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>

                <!-- Notes -->
                <div class="card p-4">
                    <h3 class="font-bold text-muji-dark mb-3"><i class="fa-solid fa-pen-to-square mr-2 text-muji-accent"></i>å‚™å¿˜éŒ„</h3>
                    <textarea id="note-input" rows="3" class="muji-input mb-2" placeholder="è¼¸å…¥æ–‡å­—æˆ–ç¶²å€..."></textarea>
                    <button onclick="addNote()" class="bg-stone-600 text-white w-full py-2 rounded-lg mb-4 text-sm">æ–°å¢å‚™å¿˜</button>
                    
                    <div class="space-y-3">
            `;
            
            [...window.tripData.lists.notes].reverse().forEach((note, idx) => {
                // Auto link regex
                // const linkedText = note.text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-500 underline"><i class="fa-solid fa-link"></i> é€£çµ</a>');
                const linkedText = linkifySafe(note.text);
                const realIdx = window.tripData.lists.notes.length - 1 - idx;
                
                html += `
                    <div class="bg-gray-50 p-3 rounded-lg relative group">
                        <p class="text-sm text-gray-700 whitespace-pre-wrap pr-6">${linkedText}</p>
                        <button onclick="deleteNote(${realIdx})" class="absolute top-2 right-2 text-gray-300 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
                    </div>
                `;
            });
            
            html += `</div></div>`;
            container.innerHTML = html;
        }

        // --- 6. INFO MODULE ---
        function renderInfo(container) {
            container.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <a href="https://www.cwa.gov.tw/V8/C/" target="_blank" class="card p-4 flex flex-col items-center justify-center text-stone-600">
                        <i class="fa-solid fa-cloud-sun text-3xl mb-2 text-muji-accent"></i>
                        <span class="font-bold">æ°£è±¡ç½²</span>
                    </a>
                    <a href="https://www.windy.com/" target="_blank" class="card p-4 flex flex-col items-center justify-center text-stone-600">
                        <i class="fa-solid fa-wind text-3xl mb-2 text-muji-accent"></i>
                        <span class="font-bold">Windy</span>
                    </a>
                    <a href="javascript:void(0)" onclick="copyRoomLink()" class="card p-4 flex flex-col items-center justify-center text-stone-600">
                      <i class="fa-solid fa-share-nodes text-3xl mb-2 text-muji-accent"></i>
                      <span class="font-bold">åˆ†äº«åŒæ­¥é€£çµ</span>
                      <span class="text-xs text-gray-400 mt-1">è®“å®¶äººä¸€éµåŠ å…¥åŒæˆ¿é–“</span>
                    </a>
                </div>

                <div class="card p-4 mb-4">
                    <h3 class="font-bold mb-3 border-b pb-2">ç·Šæ€¥è¯çµ¡</h3>
                    <div class="flex justify-between items-center py-2">
                        <span><i class="fa-solid fa-user-shield w-6 text-center text-gray-400"></i> è­¦å¯Ÿå±€</span>
                        <a href="tel:110" class="bg-gray-100 px-4 py-1 rounded-full font-mono font-bold text-stone-600">110</a>
                    </div>
                    <div class="flex justify-between items-center py-2">
                        <span><i class="fa-solid fa-truck-medical w-6 text-center text-gray-400"></i> æ•‘è­·/æ¶ˆé˜²</span>
                        <a href="tel:119" class="bg-gray-100 px-4 py-1 rounded-full font-mono font-bold text-stone-600">119</a>
                    </div>
                </div>

                <div class="card p-4 mb-4 border-l-4 border-yellow-400">
                    <h3 class="font-bold mb-2 text-yellow-600"><i class="fa-solid fa-triangle-exclamation"></i> è‡ªé§•æé†’</h3>
                    <ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">
                        <li>é€£å‡åœ‹é“æ˜“å¡ï¼Œå–„ç”¨ 1968 App æŸ¥è©¢è·¯æ³ã€‚</li>
                        <li>é•·é€”é–‹è»Šï¼Œé§•é§›è‹¥ç–²å‹è«‹å‹™å¿…åœä¼‘æ¯ç«™æ›æ‰‹ã€‚</li>
                        <li>å—éƒ¨é™½å…‰å¼·ï¼Œåœè»Šæ³¨æ„è»Šå…§æº«åº¦ï¼Œå‹¿ç•™æ˜“ç‡ƒç‰©ã€‚</li>
                        <li>è·¯é‚Šåœè»Šè«‹æ³¨æ„æ”¶è²»å–®ï¼Œè¶…å•†å¯ç¹³è²»ã€‚</li>
                    </ul>
                </div>
                
                 <div class="text-center text-xs text-gray-300 mt-8 pb-4">
                    Made for Family Trip 2026
                </div>
            `;
        }

        function copyRoomLink() {
          const room = window.__ROOM_ID || localStorage.getItem("roomId");
          const url = `${location.origin}${location.pathname}?room=${encodeURIComponent(room)}`;
          navigator.clipboard?.writeText(url)
            .then(() => alert("å·²è¤‡è£½åˆ†äº«é€£çµï¼Œç›´æ¥è²¼çµ¦å®¶äººå³å¯"))
            .catch(() => prompt("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼š", url));
        }


        // --- ACTION HANDLERS ---
        
        // Modal & Overlay System
        function createModal(contentHtml) {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            overlay.id = 'active-modal';
            overlay.innerHTML = `
                <div class="bg-white rounded-xl w-full max-w-sm max-h-[90vh] overflow-y-auto modal-enter p-5 relative">
                    <button onclick="closeModal()" class="absolute top-3 right-3 text-gray-400 text-lg"><i class="fa-solid fa-times"></i></button>
                    ${contentHtml}
                </div>
            `;
            document.body.appendChild(overlay);
            // Trigger animation
            setTimeout(() => overlay.querySelector('div').classList.add('modal-enter-active'), 10);
        }

        function closeModal() {
            const m = document.getElementById('active-modal');
            if(m) m.remove();
        }

        // Food Actions
        function openAddFoodModal() {
            const html = `
                <h3 class="text-lg font-bold mb-4">æ–°å¢ç¾é£Ÿ</h3>
                <div class="space-y-3">
                    <input type="text" id="food-name" placeholder="åç¨± (å¿…å¡«)" class="muji-input">
                    <div class="flex gap-2">
                        <select id="food-area" class="muji-input">
                            <option value="é«˜é›„">é«˜é›„</option>
                            <option value="å¢¾ä¸">å¢¾ä¸</option>
                            <option value="å°å—">å°å—</option>
                            <option value="å˜‰ç¾©">å˜‰ç¾©</option>
                        </select>
                         <select id="food-price" class="muji-input">
                            <option value="$">$ å¹³åƒ¹</option>
                            <option value="$$">$$ ä¸­åƒ¹</option>
                            <option value="$$$">$$$ å¥¢è¯</option>
                        </select>
                    </div>
                    <select id="food-type" class="muji-input">
                        <option value="å°åƒ">å°åƒ</option>
                        <option value="é¤å»³">é¤å»³</option>
                        <option value="ç”œé»">ç”œé»</option>
                        <option value="é£²æ–™">é£²æ–™</option>
                    </select>
                    <textarea id="food-note" rows="2" placeholder="å‚™è¨» (ç‡Ÿæ¥­æ™‚é–“ã€å¿…é»...)" class="muji-input"></textarea>
                    <button onclick="saveNewFood()" class="w-full bg-muji-dark text-white py-2 rounded-lg font-bold mt-2">å„²å­˜</button>
                </div>
            `;
            createModal(html);
        }

        function saveNewFood() {
            const name = document.getElementById('food-name').value;
            if(!name) return alert('è«‹è¼¸å…¥åç¨±');
            
            const item = {
                name,
                area: document.getElementById('food-area').value,
                price: document.getElementById('food-price').value,
                type: document.getElementById('food-type').value,
                note: document.getElementById('food-note').value,
                eaten: false
            };
            window.tripData.food.unshift(item);
            saveData('food');
            closeModal();
            renderView();
        }

        function toggleFoodEaten(idx) {
            window.tripData.food[idx].eaten = !window.tripData.food[idx].eaten;
            saveData('food');
            renderView();
        }

        function deleteFood(idx) {
            if(confirm('ç¢ºå®šåˆªé™¤?')) {
                window.tripData.food.splice(idx, 1);
                saveData('food');
                renderView();
            }
        }

        // Add Food to Plan
        function openAddToPlanFromFood(foodIdx) {
            const food = window.tripData.food[foodIdx];
            let options = '';
            window.tripData.plan.forEach((day, idx) => {
                options += `<option value="${idx}">${day.date} (${day.title.split('ï¼š')[1]})</option>`;
            });

            const html = `
                <h3 class="text-lg font-bold mb-2">åŠ å…¥è¡Œç¨‹</h3>
                <p class="text-sm text-gray-500 mb-4">å°‡ã€Œ${food.name}ã€æ’å…¥è¡Œç¨‹</p>
                <div class="space-y-3">
                    <label class="text-xs text-gray-400">é¸æ“‡æ—¥æœŸ</label>
                    <select id="plan-day-select" class="muji-input">${options}</select>
                    <label class="text-xs text-gray-400">æ™‚æ®µ</label>
                    <select id="plan-time-select" class="muji-input">
                        <option value="æ—©é¤">æ—©é¤</option>
                        <option value="åˆé¤">åˆé¤</option>
                        <option value="ä¸‹åˆèŒ¶">ä¸‹åˆèŒ¶</option>
                        <option value="æ™šé¤">æ™šé¤</option>
                        <option value="å®µå¤œ">å®µå¤œ</option>
                    </select>
                    <button onclick="executeAddToPlan(${foodIdx})" class="w-full bg-stone-600 text-white py-2 rounded-lg font-bold mt-2">ç¢ºèªåŠ å…¥</button>
                </div>
            `;
            createModal(html);
        }

        function executeAddToPlan(foodIdx) {
            const dayIdx = document.getElementById('plan-day-select').value;
            const time = document.getElementById('plan-time-select').value;
            const food = window.tripData.food[foodIdx];

            const newItem = {
                time: time,
                title: food.name,
                desc: `[ç¾é£Ÿ] ${food.note || food.type}`,
                type: 'food',
                isCustom: true,
                done: false
            };

            window.tripData.plan[dayIdx].items.push(newItem);
            // Simple sort by time logic (Morning < Noon < Afternoon < Evening) - Optional, just append for now
            saveData('plan');
            closeModal();
            alert('å·²åŠ å…¥è¡Œç¨‹è¡¨');
            // switchTab('plan'); // Optional: auto jump
        }

        // Plan+ Actions
        function openAddPlanModal(dayIdx) {
            const html = `
                <h3 class="text-lg font-bold mb-4">æ–°å¢è‡ªè¨‚è¡Œç¨‹</h3>
                <div class="space-y-3">
                    <input type="text" id="custom-plan-title" placeholder="æ¨™é¡Œ/åœ°é» (å¿…å¡«)" class="muji-input">
                    <div class="flex gap-2">
                         <input type="text" id="custom-plan-time" placeholder="æ™‚é–“ (ex: 14:00)" class="muji-input w-1/2">
                         <input type="text" id="custom-plan-badge" placeholder="è»Šç¨‹ (ex: 30m)" class="muji-input w-1/2">
                    </div>
                    <textarea id="custom-plan-desc" rows="2" placeholder="å‚™è¨»èªªæ˜..." class="muji-input"></textarea>
                    <button onclick="saveCustomPlan(${dayIdx})" class="w-full bg-muji-dark text-white py-2 rounded-lg font-bold mt-2">åŠ å…¥è¡Œç¨‹</button>
                </div>
            `;
            createModal(html);
        }

        function saveCustomPlan(dayIdx) {
            const title = document.getElementById('custom-plan-title').value;
            if(!title) return alert('è«‹è¼¸å…¥æ¨™é¡Œ');

            const newItem = {
                time: document.getElementById('custom-plan-time').value || 'å½ˆæ€§',
                title: title,
                desc: document.getElementById('custom-plan-desc').value || 'è‡¨æ™‚è¡Œç¨‹',
                badge: document.getElementById('custom-plan-badge').value ? 'ğŸš— ' + document.getElementById('custom-plan-badge').value : null,
                type: 'custom',
                isCustom: true,
                done: false
            };
            
            window.tripData.plan[dayIdx].items.push(newItem);
            saveData('plan');
            closeModal();
            renderView();
        }

        function deletePlanItem(dayIdx, itemIdx) {
            if(confirm('ç¢ºå®šç§»é™¤æ­¤è¡Œç¨‹?')) {
                window.tripData.plan[dayIdx].items.splice(itemIdx, 1);
                saveData('plan');
                renderView();
            }
        }

        // Wallet Logic
        let currentImgData = null;
        const MAX_LOCAL_IMAGE_BYTES = 400 * 1024;

        
        function handleImagePreview(input) {
            try {
                if (!input.files || !input.files[0]) return;
                const file = input.files[0];
                
                // 1) åŸå§‹æª”æ¡ˆå¤§å°å…ˆæ“‹
                if (file.size > MAX_LOCAL_IMAGE_BYTES) {
                  currentImgData = null;
                  input.value = ""; // æ¸…æ‰é¸æª”
                  document.getElementById('img-preview-area').classList.add('hidden');
                  alert("ç…§ç‰‡è«‹ç•™åœ¨æ‰‹æ©Ÿä¸Šè§€è³å°±å¥½ï¼Œè«‹å‹¿å­˜ç…§ç‰‡ä¸Šä¾†ã€‚");
                  return;
                }
              
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 600; 
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);

                        // 2) å£“ç¸®å¾Œå†ç”¢ base64
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                        
                        // 3) å£“ç¸®å¾Œçš„ base64 ä¹Ÿå¯ä»¥å†ä¼°ç®—ä¸€æ¬¡å¤§å°ï¼ˆæ›´æº–ï¼‰
                        const approxBytes = Math.ceil((dataUrl.length - "data:image/jpeg;base64,".length) * 3 / 4);
                        if (approxBytes > MAX_LOCAL_IMAGE_BYTES) {
                          currentImgData = null;
                          input.value = "";
                          document.getElementById('img-preview-area').classList.add('hidden');
                          alert("ç…§ç‰‡è«‹ç•™åœ¨æ‰‹æ©Ÿä¸Šè§€è³å°±å¥½ï¼Œè«‹å‹¿å­˜ç…§ç‰‡ä¸Šä¾†ã€‚");
                          return;
                        }
                        currentImgData = dataUrl;
                        document.getElementById('img-preview-area').classList.remove('hidden');
                      };
                  };

                reader.readAsDataURL(file);
            } catch (err) {
                currentImgData = null;
                input.value = "";
                document.getElementById('img-preview-area').classList.add('hidden');
                alert("ç…§ç‰‡è™•ç†å¤±æ•—ï¼Œå»ºè­°ä¸è¦ä¸Šå‚³ç…§ç‰‡ï¼Œç•™åœ¨æ‰‹æ©Ÿä¸Šè§€è³å³å¯ã€‚");
            }
        }

        function addExpense() {
            const name = document.getElementById('exp-name').value;
            const amount = document.getElementById('exp-amount').value;
            const cat = document.getElementById('exp-cat').value;
            
            if(!name || !amount) return alert('è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š');

            const now = new Date();
            const dateStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;

            const id = (crypto?.randomUUID?.() ?? (Date.now() + "-" + Math.random().toString(16).slice(2)));

            window.tripData.wallet.entries.push({
                id,
                name, amount, cat, 
                date: dateStr, 
                img: currentImgData
            });
            
            // Reset
            currentImgData = null;
            document.getElementById('exp-name').value = "";
            document.getElementById('exp-amount').value = "";
            
            const imgInput = document.getElementById('exp-img');
            if (imgInput) imgInput.value = ""; // æœ‰äº›ç€è¦½å™¨è¦é€™æ¨£æ‰èƒ½æ¸…æ‰é¸æª”

            const preview = document.getElementById('img-preview-area');
            if (preview) preview.classList.add('hidden');
            
            saveData('wallet');
            renderView();
        }

        function deleteExpense(idx) {
            if(confirm('åˆªé™¤æ­¤ç­†ç´€éŒ„?')) {
                window.tripData.wallet.entries.splice(idx, 1);
                saveData('wallet');
                renderView();
            }
        }

        function toggleCalculator() {
            document.getElementById('calculator-panel').classList.toggle('hidden');
        }

        function runCalc() {
            const val = document.getElementById('calc-input').value;
            try {
                if (val.length > 80) return document.getElementById('calc-result').innerText = 'Too long';
                
                // Basic validation allowing only numbers and operators
                if(/^[0-9+\-*/().\s]*$/.test(val)) {
                    const res = new Function('return ' + val)();
                    document.getElementById('calc-result').innerText = '= ' + res;
                } else {
                    document.getElementById('calc-result').innerText = 'Error';
                }
            } catch(e) {
                document.getElementById('calc-result').innerText = 'Error';
            }
        }
        
        function viewImage(src) {
            const html = `<img src="${src}" class="w-full rounded-lg">`;
            createModal(html);
        }

        // List Logic
        function toggleChecklist(idx) {
            window.tripData.lists.checklist[idx].done = !window.tripData.lists.checklist[idx].done;
            saveData('lists');
            renderView();
        }
        
        function addChecklist() {
            const val = document.getElementById('new-check-item').value;
            if(val) {
                window.tripData.lists.checklist.push({text: val, done: false});
                saveData('lists');
                renderView();

                document.getElementById('new-check-item').value = "";
            }
        }

        function addNote() {
            const val = document.getElementById('note-input').value;
            if(val) {
                window.tripData.lists.notes.push({text: val});
                saveData('lists');
                renderView();

                document.getElementById('note-input').value = "";
            }
        }

        function deleteNote(idx) {
            window.tripData.lists.notes.splice(idx, 1);
            saveData('lists');
            renderView();
        }

        // Initialize App
        window.addEventListener('DOMContentLoaded', init);

    </script>

    <script type="module">
        const MAX_CLOUD_DOC_BYTES = 900 * 1024; // å…ˆç”¨ 900KB ç•¶å®‰å…¨ç·šï¼ˆé¿å…é€¼è¿‘ä¸Šé™ï¼‰
        const encoder = new TextEncoder();
        
        function estimateBytes(obj) {
            return encoder.encode(JSON.stringify(obj)).length;
        }
        
        function stripImagesForCloud(tripData) {
          // ä¿ç•™å…¶ä»–è³‡æ–™ï¼Œwallet çš„ img ä¸ä¸Šé›²ï¼ˆåªç•™åœ¨æ‰‹æ©Ÿï¼‰
          const cloned = JSON.parse(JSON.stringify(tripData));
          if (cloned?.wallet?.entries?.length) {
            cloned.wallet.entries = cloned.wallet.entries.map(({ img, ...rest }) => rest);
          }
          return cloned;
        }

        function buildLocalWalletImgMap(tripData) {
          const map = new Map();
          const entries = tripData?.wallet?.entries || [];
          for (const e of entries) {
            if (e?.id && e?.img) map.set(e.id, e.img);
          }
          return map;
        }
        
        function restoreLocalWalletImages(tripData, imgMap) {
          const entries = tripData?.wallet?.entries || [];
          for (const e of entries) {
            if (e?.id && imgMap.has(e.id)) e.img = imgMap.get(e.id);
          }
        }

        window.__cloudReady = false;
        
        function setCloudStatus(state) {
          const el = document.getElementById("cloud-status");
          if (!el) return;
        
          const map = {
            offline:  { cls: "bg-gray-200 text-gray-500", icon: "fa-solid fa-wifi", text: "é›¢ç·š" },
            connecting:{ cls:"bg-gray-100 text-muji-sub", icon:"fa-solid fa-circle-notch fa-spin", text:"é€£ç·šä¸­" },
            ready:    { cls:"bg-blue-50 text-blue-600", icon:"fa-solid fa-cloud", text:"å·²é€£ç·š" },
            syncing:  { cls:"bg-yellow-50 text-yellow-700", icon:"fa-solid fa-arrows-rotate fa-spin", text:"åŒæ­¥ä¸­" },
            synced:   { cls:"bg-green-50 text-green-700", icon:"fa-solid fa-circle-check", text:"å·²åŒæ­¥" },
            error:    { cls:"bg-red-50 text-red-600", icon:"fa-solid fa-triangle-exclamation", text:"åŒæ­¥å¤±æ•—" },
            disabled: { cls:"bg-gray-100 text-gray-400", icon:"fa-solid fa-cloud-slash", text:"æœªå•Ÿç”¨" }
          };
        
          const s = map[state] || map.connecting;
          el.className = `text-[11px] px-2 py-1 rounded-full ${s.cls}`;
          el.innerHTML = `<i class="${s.icon} mr-1"></i>${s.text}`;
        }
        
        // è·Ÿè‘—ç¶²è·¯ç‹€æ…‹è®Š
        setCloudStatus(navigator.onLine ? "connecting" : "offline");
        window.addEventListener("online",  () => setCloudStatus("connecting"));
        window.addEventListener("offline", () => setCloudStatus("offline"));


      // ======= Firebase Imports =======
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
      import { getAuth, signInAnonymously } 
          from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

      // import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
      import {
        getFirestore,
        doc,
        onSnapshot,
        setDoc,
        serverTimestamp
      } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries
    
      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyDbtFcUlgnZeArsNJvj67bVPatuHhe0XEU",
        authDomain: "cny-trip-2026.firebaseapp.com",
        projectId: "cny-trip-2026",
        storageBucket: "cny-trip-2026.firebasestorage.app",
        messagingSenderId: "893600056741",
        appId: "1:893600056741:web:1ce9fa98f84e3b22a4d44c",
        measurementId: "G-G0S3WX1K7S"
      };
    
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      // try {
      //     await signInAnonymously(auth);
      //     window.__cloudReady = true;
      //     } catch (e) {
      //     window.__cloudReady = false;
      //     alert("é›²ç«¯åŒæ­¥æœªå•Ÿç”¨ï¼šè«‹åˆ° Firebase Console é–‹å•Ÿ Anonymous ç™»å…¥ã€‚");
      //     console.error(e);
      //   }
     
      // âœ… å…ˆå®šç¾© tripRefï¼ˆé¿å… TDZï¼‰
      // const ROOM_ID = "CNY2026";
      // const tripRef = doc(db, "trips", ROOM_ID);
        
        const params = new URLSearchParams(location.search);
        let ROOM_ID = params.get("room") || localStorage.getItem("roomId");
        
        if (!ROOM_ID) {
          ROOM_ID = crypto?.randomUUID?.() || (Date.now() + "-" + Math.random().toString(16).slice(2));
          localStorage.setItem("roomId", ROOM_ID);
        }

        window.__ROOM_ID = ROOM_ID;
        
        // å†ç”¨ ROOM_ID å»º tripRef
        const tripRef = doc(db, "trips", ROOM_ID);

      let cloudSyncInFlight = false;
      window.__pushTripToCloud = async () => {

          // å…ˆåˆ¤æ–·ç‹€æ…‹
          if (!navigator.onLine) { setCloudStatus("offline"); return; }
          if (!window.__cloudReady) { setCloudStatus("disabled"); return; }

          // é¿å…ä¸¦ç™¼å¯«å…¥
          if (cloudSyncInFlight) return;
          cloudSyncInFlight = true;
          
          setCloudStatus("syncing");
      
          try {
        
            // å…ˆåšã€Œä¸ä¸Šå‚³ç…§ç‰‡ã€çš„ç‰ˆæœ¬ï¼ˆæœ€ç©©ï¼‰
            const cloudData = stripImagesForCloud(window.tripData);

            // ä¸Šé›²å‰ä¼°ç®—å¤§å°
            const bytes = estimateBytes({ tripData: cloudData });
            if (bytes > MAX_CLOUD_DOC_BYTES) {
              // ä½ è¦çš„ï¼šè¶…éå°±ä¸Ÿ exception + æç¤ºè¨Šæ¯
              throw new Error("TRIP_DOC_TOO_LARGE");
            }
          
            // setDoc å¯ç”¨ merge é¿å…æ•´ä»½è¦†è“‹å…¶ä»–æ¬„ä½ :contentReference[oaicite:7]{index=7}
            await setDoc(
                tripRef,
                {tripData: cloudData, updatedAt: serverTimestamp() },
                { merge: true }
            );
              
            setCloudStatus("synced");
                  
            } catch (err) {
                setCloudStatus("error");
                console.error("[setDoc] ", err?.code, err?.message, err);
              
                // suppressNextRemote = false;
                // if (err && err.message === "TRIP_DOC_TOO_LARGE") {
                if (err?.message === "TRIP_DOC_TOO_LARGE") {
                  alert("é›²ç«¯åŒæ­¥å®¹é‡å·²æ¥è¿‘ä¸Šé™ã€‚ç…§ç‰‡è«‹ç•™åœ¨æ‰‹æ©Ÿä¸Šè§€è³å°±å¥½ï¼Œè«‹å‹¿å­˜ç…§ç‰‡ä¸Šä¾†ã€‚");
                  return;
                }
                // Firestore çœŸçš„å›ä½  size è¶…é™ç­‰éŒ¯èª¤æ™‚ï¼Œä¹Ÿç”¨åŒä¸€å¥æç¤º
                //ï¼ˆä¸åŒç‰ˆæœ¬éŒ¯èª¤å­—ä¸²å¯èƒ½ä¸åŒï¼Œæ‰€ä»¥ç”¨ä¿å®ˆçš„ fallbackï¼‰
                alert(`åŒæ­¥åˆ°é›²ç«¯å¤±æ•—ï¼š${err?.code || ""}\n${err?.message || err}`);
                console.error(err);
              } finally {
                cloudSyncInFlight = false;
              }
          };
                
      window.__cloudReady = false;
        
      (async () => {

          setCloudStatus(navigator.onLine ? "connecting" : "offline");
          // 1) å…ˆç™»å…¥
          try {
            await signInAnonymously(auth);
            window.__cloudReady = true;
          } catch (e) {
            window.__cloudReady = false;
            alert("é›²ç«¯åŒæ­¥æœªå•Ÿç”¨ï¼šè«‹åˆ° Firebase Console é–‹å•Ÿ Anonymous ç™»å…¥ã€‚");
            console.error(e);
            return; // â—ç™»å…¥å¤±æ•—ï¼šä¸è¦å¾€ä¸‹å•Ÿå‹• onSnapshot
          }

          // 2) ç™»å…¥æˆåŠŸå¾Œå†å•Ÿå‹•å³æ™‚ç›£è½
          onSnapshot(tripRef, { includeMetadataChanges: true }, async (snap) => {
            // å¿½ç•¥æœ¬åœ° pending writes çš„ snapshotï¼ˆé¿å…è‡ªå·± setDoc å¾Œç«‹åˆ»å›å½ˆï¼‰
            if (snap.metadata.hasPendingWrites) return;
        
            // ç¬¬ä¸€æ¬¡æ²’æœ‰æ–‡ä»¶ï¼šæŠŠç›®å‰æœ¬æ©Ÿè³‡æ–™å…ˆä¸Šå‚³å»ºç«‹ä¸€ä»½
            if (!snap.exists()) {
              await window.__pushTripToCloud();
              return;
            }
            const data = snap.data();
            const remoteTrip = data?.tripData;
            if (!remoteTrip) return;

            // å…ˆå‚™ä»½ã€Œæœ¬æ©Ÿç…§ç‰‡æ˜ å°„ã€
            const localImgMap = buildLocalWalletImgMap(window.tripData);
        
            // ç”¨é›²ç«¯è³‡æ–™è¦†è“‹
            window.tripData = remoteTrip;
        
            // æŠŠæœ¬æ©Ÿç…§ç‰‡è£œå›ä¾†ï¼ˆåªåœ¨æœ¬æ©Ÿä¿ç•™ï¼‰
            restoreLocalWalletImages(window.tripData, localImgMap);
        
            // åŒæ­¥åˆ° localStorageï¼ˆé›¢ç·šå¯ç”¨ï¼‰
            localStorage.setItem(window.DB_KEY_PLAN, JSON.stringify(window.tripData.plan));
            localStorage.setItem(window.DB_KEY_WALLET, JSON.stringify(window.tripData.wallet));
            localStorage.setItem(window.DB_KEY_LISTS, JSON.stringify(window.tripData.lists));
            localStorage.setItem(window.DB_KEY_FOOD, JSON.stringify(window.tripData.food));
        
            // é‡æ–°æ¸²æŸ“
            if (typeof window.renderView === "function") window.renderView();
            setCloudStatus("synced");
          },
          (err) => {
            setCloudStatus("error");
            console.error("[onSnapshot] ", err?.code, err?.message, err);
            alert(`é›²ç«¯ç›£è½å¤±æ•—ï¼š${err?.code || ""}\n${err?.message || err}`);
          }
        );
        })();

        
      // const ROOM_ID = "CNY2026";  
      // const tripRef = doc(db, "trips", ROOM_ID);
    
      let suppressNextRemote = false;
    </script>

    
</body>
</html>
